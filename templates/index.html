<!-- 
Autor: Ing. Walter Rodr√≠guez
Fecha: 2026-02-18
Descripci√≥n: Interfaz Premium de Avatar 3D con Lip-Sync local. Modelos GLB servidos localmente (Ready Player Me cerrado ene-2026).
-->
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar IA Premium - Ing. Walter Rodriguez</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Importmap oficial basado en examples/minimal.html del repo TalkingHead -->
    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.180.0/build/three.module.js/+esm",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/",
        "talkinghead": "https://cdn.jsdelivr.net/gh/met4citizen/TalkingHead@1.7/modules/talkinghead.mjs"
      }
    }
    </script>
    <style>
        :root {
            --primary: #c084fc;
            --primary-dark: #9333ea;
            --accent: #2dd4bf;
            --bg: #020617;
            --card-bg: rgba(15, 23, 42, 0.7);
            --text: #f8fafc;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --panel-width: 400px;
        }

        * {
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-dark) transparent;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg);
            color: var(--text);
            overflow: hidden;
            display: flex;
        }

        /* Fondo Animado */
        .glow-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 30%, rgba(147, 51, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(45, 212, 191, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        #app-container {
            width: 100%;
            height: 100%;
            display: flex;
            position: relative;
        }

        #avatar-view {
            flex: 1;
            height: 100%;
            position: relative;
            background: transparent;
            transition: all 0.5s ease;
        }

        #canvas-wrapper {
            width: 100%;
            height: 100%;
        }

        /* Panel Lateral Premium */
        .side-panel {
            width: var(--panel-width);
            height: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(30px) saturate(150%);
            border-left: 1px solid var(--glass-border);
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 100;
            overflow-y: auto;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .side-panel.hidden {
            transform: translateX(100%);
        }

        .header {
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 15px;
            margin-bottom: 5px;
        }

        .header h1 {
            font-size: 22px;
            margin: 0;
            background: linear-gradient(135deg, #fff 0%, #a855f7 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 11px;
            color: #94a3b8;
            margin: 4px 0 0 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Grupos de Control */
        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, var(--glass-border), transparent);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        textarea {
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px;
            color: white;
            font-size: 14px;
            resize: none;
            transition: all 0.3s;
        }

        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(192, 132, 252, 0.2);
            outline: none;
        }

        select,
        input[type="text"] {
            width: 100%;
            padding: 10px 14px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: white;
            font-size: 13px;
        }

        /* Botones */
        .btn {
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
            font-size: 13px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(147, 51, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(147, 51, 234, 0.5);
        }

        .btn-secondary {
            background: var(--glass);
            color: #cbd5e1;
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
            color: white;
        }

        /* Grid de Gestos y Emociones */
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .icon-btn {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        /* Sliders Custom */
        .slider-row {
            display: grid;
            grid-template-columns: 80px 1fr 40px;
            align-items: center;
            gap: 10px;
            font-size: 11px;
            color: #94a3b8;
        }

        input[type="range"] {
            accent-color: var(--primary);
            height: 4px;
        }

        /* Status & Labels */
        .badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .badge-premium {
            background: rgba(45, 212, 191, 0.1);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        /* Floating Controls */
        #obs-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 200;
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            padding: 10px;
            border-radius: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        /* Loading */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }

        .loader-ring {
            width: 80px;
            height: 80px;
            border: 2px solid var(--glass-border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s infinite cubic-bezier(0.5, 0, 0.5, 1);
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* Galer√≠a de Avatares */
        .avatar-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
            margin-bottom: 15px;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }

        .avatar-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .avatar-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .avatar-card.active {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.3);
        }

        .avatar-card .status-dot {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-local {
            background: #22c55e;
        }

        .status-cloud {
            background: #3b82f6;
        }

        .avatar-card span {
            font-size: 9px;
            display: block;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Gestos Corporales Custom */
        .gesture-btn {
            background: rgba(147, 51, 234, 0.1);
            border: 1px solid rgba(147, 51, 234, 0.3);
            color: var(--primary);
            padding: 6px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            text-align: center;
        }

        .gesture-btn:hover {
            background: var(--primary-dark);
            color: white;
        }

        /* Botones de Preset de Encuadre - Ing. Walter Rodr√≠guez 2026-02-20 */
        .preset-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            padding: 8px 4px;
            background: rgba(192, 132, 252, 0.07);
            border: 1px solid rgba(192, 132, 252, 0.2);
            border-radius: 8px;
            color: #c084fc;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.18s;
            font-family: 'Outfit', sans-serif;
            text-align: center;
            line-height: 1.2;
        }

        .preset-btn:hover {
            background: rgba(192, 132, 252, 0.2);
            border-color: rgba(192, 132, 252, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(192, 132, 252, 0.15);
        }

        .preset-btn:active {
            transform: translateY(0);
            background: rgba(147, 51, 234, 0.3);
        }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            .side-panel {
                width: 100%;
                position: absolute;
                height: 50%;
                bottom: 0;
                left: 0;
                border-left: none;
                border-top: 1px solid var(--glass-border);
            }

            #avatar-view {
                height: 50%;
            }
        }

        /* Sistema de Inventario Premium - Autor: Ing. Walter Rodr√≠guez - 2026-02-20 */
        #inventory-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            display: none;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
            animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .media-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .media-container img,
        .media-container video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .item-info {
            text-align: center;
        }

        .item-name {
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .item-desc {
            font-size: 11px;
            color: #94a3b8;
            line-height: 1.4;
        }

        .inventory-ctrl-group {
            background: rgba(168, 85, 247, 0.05);
            border: 1px dashed rgba(168, 85, 247, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .counter-badge {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
        }
    </style>
    </style>
</head>

<body>
    <div class="glow-mesh"></div>

    <div id="loading-overlay">
        <div class="loader-ring"></div>
        <h2 id="loading-text" style="margin-top:20px; font-weight:300; letter-spacing:2px;">SISTEMA INICIANDO</h2>
        <p style="font-size:10px; color:#64748b; margin-top:10px;">PROCESADOR INTEL ULTRA 7 DETECTADO</p>
    </div>

    <div id="obs-toggle">
        <div style="width:10px; height:10px; border-radius:50%; background:#ef4444; box-shadow:0 0 10px #ef4444;"></div>
        MODO STREAMING (H)
    </div>

    <div id="app-container">
        <div id="avatar-view">
            <div id="canvas-wrapper"></div>

            <!-- Visor de Inventario -->
            <div id="inventory-overlay">
                <div class="media-container" id="media-view">
                    <!-- Din√°mico -->
                </div>
                <div class="item-info">
                    <div class="item-name" id="display-name">-</div>
                    <div class="item-desc" id="display-desc">-</div>
                </div>
            </div>

            <div style="position:absolute; bottom:30px; left:30px; display:flex; flex-direction:column; gap:5px;">
                <span class="badge badge-premium">REALISMO ARKIT ACTIVO (52 BLENDSHAPES)</span>
                <span style="font-size:10px; opacity:0.5;">¬© 2026 Ing. Walter Rodr√≠guez | Aliado IA</span>
            </div>
        </div>

        <div class="side-panel" id="main-panel">
            <div class="header">
                <h1>AVATAR PREMIUM 3.0</h1>
                <p>NPU Optimized | Edge-TTS Neural</p>
            </div>

            <!-- CHAT / INPUT -->
            <div class="control-group">
                <div class="section-title">Comunicaci√≥n Humana</div>
                <textarea id="text-input" placeholder="¬øQu√© quieres que diga hoy?"></textarea>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-primary" id="speak-btn" style="flex:2;">
                        <span>HABLAR AHORA</span>
                    </button>
                    <!-- ADAPTAR: usa Gemini IA para enriquecer el texto con expresiones faciales -->
                    <!-- Autor: Ing. Walter Rodr√≠guez - 2026-02-20 -->
                    <button class="btn btn-secondary" id="adaptar-btn"
                        style="flex:1; background:linear-gradient(135deg,rgba(99,102,241,0.3),rgba(168,85,247,0.3)); border-color:rgba(99,102,241,0.5);"
                        title="IA analiza el texto y agrega expresiones faciales autom√°ticamente">
                        ‚ú® ADAPTAR
                    </button>
                </div>

                <!-- Secci√≥n de Inventario - Autor: Ing. Walter Rodr√≠guez - 2026-02-20 -->
                <div class="inventory-ctrl-group">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                        <span style="font-size:11px; font-weight:600; color:#a855f7;">INVENTARIO LIVE</span>
                        <span id="inventory-counter" class="counter-badge">0/0</span>
                    </div>
                    <button class="btn btn-primary" id="next-item-btn" disabled
                        style="padding: 12px; background: linear-gradient(135deg, #a855f7, #7c3aed);">
                        üì¶ ART√çCULO SIGUIENTE
                    </button>
                    <p style="font-size:9px; color:#64748b; text-align:center;">Haga clic para presentar el siguiente
                        producto</p>
                </div>
                <!-- Bot√≥n Test API -->
                <button id="test-api-btn" style="width:100%; margin-top:6px; padding:6px 0; font-size:10px; letter-spacing:1px;
                           background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3);
                           border-radius:6px; color:#6ee7b7; cursor:pointer; font-family:inherit;"
                    title="Verifica si tu Google-API-KEY funciona y qu√© modelos tiene disponibles">
                    üîç TEST API GEMINI
                </button>
            </div>

            <!-- GESTOS Y EMOCIONES -->
            <div class="control-group">
                <div class="section-title">Expresiones Faciales</div>
                <div class="grid-4">
                    <button class="icon-btn" onclick="addExpression('(feliz)')" title="Feliz">üòä</button>
                    <button class="icon-btn" onclick="addExpression('(triste)')" title="Triste">üòû</button>
                    <button class="icon-btn" onclick="addExpression('(enojo)')" title="Enojo">üò†</button>
                    <button class="icon-btn" onclick="addExpression('(sorpresa)')" title="Sorpresa">üòÆ</button>
                    <button class="icon-btn" onclick="addExpression('(gui√±o)')" title="Gui√±o">üòâ</button>
                    <button class="icon-btn" onclick="addExpression('(serio)')" title="Serio">üòê</button>
                    <button class="icon-btn" onclick="addExpression('(broma)')" title="Broma">üòú</button>
                    <button class="icon-btn" onclick="addExpression('(llorar)')" title="Llorar">üò≠</button>
                </div>
            </div>

            <div class="control-group">
                <div class="section-title">Biblioteca de Avatares</div>
                <!-- Link al creador de avatares -->
                <a href="https://readyplayer.me/es/avatar" target="_blank" style="display:flex; align-items:center; gap:8px; background:rgba(192,132,252,0.1);
                           border:1px solid rgba(192,132,252,0.3); border-radius:8px; padding:8px 10px;
                           text-decoration:none; color:#c084fc; font-size:11px; margin-bottom:10px;
                           transition:background 0.2s;" onmouseover="this.style.background='rgba(192,132,252,0.2)'"
                    onmouseout="this.style.background='rgba(192,132,252,0.1)'">
                    <span style="font-size:18px;">üé®</span>
                    <div>
                        <div style="font-weight:600;">Dise√±a tu Avatar Gratis</div>
                        <div style="opacity:0.7; font-size:10px;">readyplayer.me ‚Üí Crea, copia el link .glb</div>
                    </div>
                    <span style="margin-left:auto;">‚Üó</span>
                </a>
                <div id="avatar-gallery" class="avatar-gallery">
                    <!-- Los avatares se cargar√°n aqu√≠ din√°micamente -->
                </div>
                <div style="margin-top:10px;">
                    <input type="text" id="custom-url-input" placeholder="URL de ReadyPlayerMe (.glb)"
                        style="width:100%; margin-bottom:5px;">
                    <button class="btn btn-secondary" style="width:100%; font-size:11px;" id="download-btn">DESCARGAR
                        NUEVO AVATAR</button>
                </div>
            </div>

            <div class="control-group">
                <div class="section-title">Hardware & Voz</div>
                <label style="font-size:11px;">Voz Neural (Edge)</label>
                <select id="voice-select"></select>

                <div class="slider-row" style="margin-top:10px;">
                    <span>VELOCIDAD</span>
                    <input type="range" id="rate-range" min="-30" max="30" value="10">
                    <span id="rate-value">+10%</span>
                </div>
            </div>

            <!-- ENCUADRE PROFESIONAL CON PRESETS -->
            <!-- Autor: Ing. Walter Rodr√≠guez - 2026-02-20 -->
            <!-- Presets calculados desde los valores observados en la imagen: h=0.86, z=0.36, r=0 -->
            <div class="control-group">
                <div class="section-title">Encuadre Profesional</div>

                <!-- Botones de Preset de C√°mara -->
                <!-- Valores calibrados: referencia base cuerpo completo = h:0.86, z:0.36, r:0 -->
                <!-- Autor: Ing. Walter Rodr√≠guez - 2026-02-20 -->
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:6px; margin-bottom:10px;">

                    <!-- Cuerpo completo: target.y al centro del cuerpo (~0.9 = cintura-pecho) -->
                    <!-- Recalibrado para controls.target.y ‚Äî Ing. Walter Rodr√≠guez 2026-02-20 -->
                    <button class="preset-btn" onclick="applyPreset(0.90, 0.36, 0)"
                        title="Cuerpo Completo - Vista frontal completa">
                        <span style="font-size:18px;">&#129333;</span>
                        <span>Completo</span>
                    </button>

                    <!-- Cintura arriba: apuntar a la cintura ~1.05, zoom moderado -->
                    <button class="preset-btn" onclick="applyPreset(1.05, 0.62, 0)" title="Cintura para arriba">
                        <span style="font-size:18px;">&#129494;</span>
                        <span>Cintura</span>
                    </button>

                    <!-- Busto: apuntar a pecho/hombros ~1.25, zoom mayor -->
                    <button class="preset-btn" onclick="applyPreset(1.25, 1.05, 0)" title="Busto / Hombros">
                        <span style="font-size:18px;">&#128100;</span>
                        <span>Busto</span>
                    </button>

                    <!-- Rostro: apuntar a la cara ~1.55, zoom primer plano -->
                    <button class="preset-btn" onclick="applyPreset(1.55, 1.90, 0)" title="Primer Plano Rostro">
                        <span style="font-size:18px;">&#128516;</span>
                        <span>Rostro</span>
                    </button>

                    <!-- Perfil derecho cuerpo: target centro del cuerpo, rot 90¬∞ -->
                    <button class="preset-btn" onclick="applyPreset(0.90, 0.36, 1.57)" title="Perfil Derecho - Cuerpo">
                        <span style="font-size:18px;">&#128694;</span>
                        <span>&#8594; Der.</span>
                    </button>

                    <!-- Perfil izquierdo cuerpo: rot -90¬∞ -->
                    <button class="preset-btn" onclick="applyPreset(0.90, 0.36, -1.57)"
                        title="Perfil Izquierdo - Cuerpo">
                        <span style="font-size:18px;">&#128694;</span>
                        <span>Izq. &#8592;</span>
                    </button>

                    <!-- Espalda: rot 180¬∞ -->
                    <button class="preset-btn" onclick="applyPreset(0.90, 0.36, 3.14)" title="Vista de Espalda">
                        <span style="font-size:18px;">&#128694;</span>
                        <span>Espalda</span>
                    </button>

                    <!-- Perfil cara derecha: target cara ~1.55, zoom rostro + rot 90¬∞ -->
                    <button class="preset-btn" onclick="applyPreset(1.55, 1.90, 1.57)" title="Perfil Rostro Derecho">
                        <span style="font-size:18px;">&#129382;</span>
                        <span>Cara Der.</span>
                    </button>

                    <!-- Perfil cara izquierda: target cara ~1.55, zoom rostro + rot -90¬∞ -->
                    <button class="preset-btn" onclick="applyPreset(1.55, 1.90, -1.57)" title="Perfil Rostro Izquierdo">
                        <span style="font-size:18px;">&#129382;</span>
                        <span>Cara Izq.</span>
                    </button>

                </div>

                <!-- Ajuste Fino Manual -->
                <div style="border-top:1px solid rgba(255,255,255,0.07); padding-top:8px;">
                    <div class="slider-row">
                        <span>ALTURA</span>
                        <input type="range" id="cam-height" min="-1" max="2" step="0.01" value="0.90">
                        <span id="h-val">0.90</span>
                    </div>
                    <div class="slider-row">
                        <span>ZOOM</span>
                        <input type="range" id="cam-zoom" min="0.1" max="5" step="0.01" value="0.36">
                        <span id="z-val">0.36</span>
                    </div>
                    <!-- GIRO EJE Y: gira el avatar izquierda/derecha (azimuth, igual al mouse drag horizontal) -->
                    <!-- Autor: Ing. Walter Rodr√≠guez - 2026-02-20 -->
                    <div class="slider-row">
                        <span>GIRO Y</span>
                        <input type="range" id="cam-rotate-y" min="-3.14" max="3.14" step="0.01" value="0">
                        <span id="ry-val">0.00</span>
                    </div>
                    <!-- GIRO EJE X: inclina la c√°mara arriba/abajo (polar angle, igual al mouse drag vertical) -->
                    <!-- Autor: Ing. Walter Rodr√≠guez - 2026-02-20 -->
                    <div class="slider-row">
                        <span>GIRO X</span>
                        <input type="range" id="cam-rotate-x" min="0.1" max="3.0" step="0.01" value="1.4">
                        <span id="rx-val">1.40</span>
                    </div>
                    <button class="btn btn-secondary" id="reset-cam-btn"
                        style="padding:6px; font-size:10px; margin-top:4px;">RESET VISTA</button>
                </div>
            </div>

            <div style="margin-top:auto; font-size:10px; color:#475569; text-align:center;">
                VERSI√ìN 3.0.0 | POWERED BY INTEL CORE ULTRA 7
            </div>
        </div>
    </div>

    <script type="module">
        import { TalkingHead } from "talkinghead";

        // Elementos UI
        const textInput = document.getElementById('text-input');
        const speakBtn = document.getElementById('speak-btn');
        const voiceSelect = document.getElementById('voice-select');
        const avatarSelect = document.getElementById('avatar-select');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const mainPanel = document.getElementById('main-panel');
        const obsToggle = document.getElementById('obs-toggle');

        let head;
        let avatarList = [];
        let currentAvatarID = '';

        // --- SISTEMA DE LOGS REMOTOS ---
        async function log(msg, level = 'info') {
            console.log(`[${level.toUpperCase()}] ${msg}`);
            try {
                await fetch('/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, level: level })
                });
            } catch (e) { }
        }

        async function init() {
            try {
                log("Iniciando Aliado IA Premium...");
                const node = document.getElementById('canvas-wrapper');

                // 1. Cargar lista de avatares desde el backend
                loadingText.innerText = "Sincronizando Avatares...";
                await refreshAvatarGallery();

                // 2. Inicializar TalkingHead con Realismo ARKit
                loadingText.innerText = "Inicializando Motor 3D...";
                head = new TalkingHead(node, {
                    cameraView: "upper",
                    lipsyncModules: ["en"],
                    cameraFov: 35,
                    ttsRate: 1.1,
                    audioVolume: 1.0,
                    audioStart: true // FORZAR inicio de audio para LipSync
                });

                // 3. Cargar Avatar Inicial (El primero local o el default)
                loadingText.innerText = "Cargando Piel Digital...";
                const initialAvatar = avatarList.find(a => a.is_local) || avatarList[0];
                await loadAvatarByID(initialAvatar.id);

                // 4. Configurar Voces
                loadingText.innerText = "Conectando con Red Neural...";
                await setupVoices();

                // 5. Configurar C√°mara por Default (Altura=0.86, Zoom=0.36)
                setTimeout(() => {
                    document.getElementById('cam-height').value = 0.90;
                    document.getElementById('cam-zoom').value = 0.36;
                    updateCamera();
                }, 1500);

                // Finalizar
                setTimeout(() => {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => loadingOverlay.style.display = 'none', 500);
                }, 1000);

                log("Sistema 3.0 Listo.");

            } catch (e) {
                log("Error fatal: " + e.message, 'error');
                loadingText.innerText = "ERROR DE CARGA";
            }
        }

        // Actualiza la galer√≠a leyendo SOLO los avatares de la carpeta local
        // Autor: Ing. Walter Rodr√≠guez - 2026-02-20
        async function refreshAvatarGallery() {
            try {
                const avResp = await fetch('/avatars');
                const avData = await avResp.json();
                avatarList = avData.avatars;

                const gallery = document.getElementById('avatar-gallery');
                gallery.innerHTML = '';

                if (avatarList.length === 0) {
                    gallery.innerHTML = '<p style="font-size:11px;color:#64748b;text-align:center;">Sin avatares. Descarga uno con el bot√≥n de abajo.</p>';
                    return;
                }

                avatarList.forEach(av => {
                    const card = document.createElement('div');
                    const isActive = currentAvatarID === av.id;
                    card.className = `avatar-card ${isActive ? 'active' : ''}`;
                    // Icono seg√∫n g√©nero (todos son locales ahora)
                    const icon = av.gender === 'M' ? '\uD83D\uDC68' : '\uD83D\uDC69';
                    card.innerHTML = `
                        <div class="status-dot status-local"></div>
                        <div style="font-size: 20px;">${icon}</div>
                        <span>${av.name}</span>
                    `;
                    // Clic directo = cargar (todos son locales)
                    card.onclick = () => loadAvatarByID(av.id);
                    gallery.appendChild(card);
                });
            } catch (e) { log("Error galer√≠a: " + e.message, 'warn'); }
        }


        // Descargar avatar desde el cat√°logo base usando su ID
        // No permite segunda descarga si ya existe localmente (el backend lo ignora pero mostramos feedback)
        async function downloadAvatarById(avatarId) {
            // Si ya es local, solo cargar
            const existing = avatarList.find(a => a.id === avatarId && a.is_local);
            if (existing) {
                log(`Avatar '${avatarId}' ya est√° local. Cargando directamente.`);
                loadAvatarByID(avatarId);
                return;
            }
            showLoading("DESCARGANDO AVATAR...");
            try {
                const resp = await fetch('/download-sample-avatar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ avatar_id: avatarId })
                });
                const data = await resp.json();
                if (data.status === 'ok') {
                    log(`Avatar '${avatarId}' listo`);
                    await refreshAvatarGallery();
                    const newId = data.avatar_id || data.path.split('/').pop().replace('.glb', '');
                    loadAvatarByID(newId);
                } else {
                    alert("‚ùå Error: " + data.message);
                }
            } catch (e) { log("Error descarga: " + e.message, 'error'); }
            finally { hideLoading(); }
        }

        // Descargar avatar desde URL personalizada pegada manualmente
        // Previene doble descarga verificando si la URL ya existe en la galer√≠a local
        async function downloadAvatar() {
            const url = document.getElementById('custom-url-input').value.trim();
            if (!url) return alert("Ingresa una URL v√°lida (.glb de ReadyPlayerMe)");

            // Verificar si ya existe un avatar local con la misma URL
            const alreadyExists = avatarList.find(a => a.is_local && a.url === url);
            if (alreadyExists) {
                alert(`\u26A0\uFE0F El avatar '${alreadyExists.name}' ya est√° descargado. Haz clic en √©l en la galer√≠a para usarlo.`);
                return;
            }

            const btn = document.getElementById('download-btn');
            btn.disabled = true;
            btn.textContent = 'DESCARGANDO...';
            showLoading("DESCARGANDO AVATAR PERSONALIZADO...");
            try {
                const resp = await fetch('/download-sample-avatar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ custom_url: url })
                });
                const data = await resp.json();
                if (data.status === 'ok') {
                    log("Avatar personalizado descargado");
                    document.getElementById('custom-url-input').value = ''; // Limpiar input
                    await refreshAvatarGallery();
                    const newId = data.avatar_id || data.path.split('/').pop().replace('.glb', '');
                    loadAvatarByID(newId);
                } else {
                    alert("‚ùå Error: " + data.message);
                }
            } catch (e) { log("Error descarga: " + e.message, 'error'); }
            finally {
                hideLoading();
                btn.disabled = false;
                btn.textContent = 'DESCARGAR NUEVO AVATAR';
            }
        }

        async function loadAvatarByID(id) {
            const avatarInfo = avatarList.find(a => a.id === id);
            if (!avatarInfo) return;

            currentAvatarID = id;
            const url = avatarInfo.is_local ? `/avatares/${id}.glb` : avatarInfo.url;
            log(`Cargando: ${avatarInfo.name} (${url})`);

            showLoading(`CONFIGURANDO: ${avatarInfo.name.toUpperCase()}`);

            try {
                await head.showAvatar({
                    url: url,
                    body: 'F',
                    avatarMood: 'neutral',
                    lipsyncLang: 'en'
                }, (ev) => {
                    if (ev.lengthComputable) {
                        let pct = Math.round(ev.loaded / ev.total * 100);
                        loadingText.innerText = `PROCESANDO: ${pct}%`;
                    }
                });

                // Actualizar galer√≠a para marcar activo
                refreshAvatarGallery();

            } catch (e) { log("Error carga avatar: " + e.message, 'error'); }
            finally { hideLoading(); }
        }

        function showLoading(text) {
            loadingOverlay.style.display = 'flex';
            loadingOverlay.style.opacity = '1';
            loadingText.innerText = text;
        }

        function hideLoading() {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
        }

        async function setupVoices() {
            try {
                const resp = await fetch('/tts-voices');
                const data = await resp.json();
                voiceSelect.innerHTML = '';
                data.voices.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.name;
                    opt.textContent = v.friendlyName;
                    voiceSelect.appendChild(opt);
                });
                const def = data.voices.find(v => v.name.includes('Ramona')) || data.voices[0];
                if (def) voiceSelect.value = def.name;
            } catch (e) { log("Error voces: " + e.message, 'warn'); }
        }

        async function handleSpeak() {
            let text = textInput.value.trim();
            if (!text || !head) return;

            speakBtn.disabled = true;
            speakBtn.style.filter = "grayscale(1)";

            try {
                // PASO 1: Reanudar AudioContext si est√° suspendido (pol√≠tica del navegador)
                // speakAudio() necesita Web Audio API activo
                if (head.audioCtx && head.audioCtx.state !== 'running') {
                    await head.audioCtx.resume();
                    log(`AudioCtx estado: ${head.audioCtx.state}`);
                }

                const rateVal = document.getElementById('rate-range').value;
                const voice = voiceSelect.value;
                const rateStr = (rateVal >= 0 ? '+' : '') + rateVal + '%';

                // Limpiar etiquetas de emoci√≥n del texto a sintetizar
                const cleanText = text.replace(/\([^)]*\)/g, '').trim();

                log(`Generando TTS: "${cleanText.substring(0, 40)}..."`);

                // PASO 2: Generar audio en el backend
                const resp = await fetch('/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: cleanText, voice: voice, rate: rateStr })
                });
                const data = await resp.json();
                if (data.status !== 'ok') throw new Error(data.message);

                // PASO 3: Descargar el MP3 como ArrayBuffer (requerido por TalkingHead)
                log(`Descargando audio ArrayBuffer...`);
                const audioResp = await fetch(data.audio_url);
                const arrayBuffer = await audioResp.arrayBuffer();

                // PASO 4: Decodificar el ArrayBuffer con el AudioContext del TalkingHead
                log(`Decodificando audio con AudioCtx...`);
                const audioBuffer = await head.audioCtx.decodeAudioData(arrayBuffer);

                // PASO 5: Construir las palabras para el lipsync
                // speakAudio() necesita { audio, words, wtimes, wdurations }
                const words = cleanText.split(' ').filter(w => w.length > 0);
                const durPerWord = audioBuffer.duration / words.length;
                const wtimes = words.map((_, i) => i * durPerWord * 1000); // ms
                const wdurations = words.map(() => durPerWord * 1000); // ms

                // Emociones ARKit ‚Äî antes de iniciar el habla
                if (text.includes('(feliz)')) head.speakEmoji('üòä');
                else if (text.includes('(triste)')) head.speakEmoji('üòû');
                else if (text.includes('(sorpresa)')) head.speakEmoji('üòÆ');
                else if (text.includes('(enojo)')) head.speakEmoji('üò†');
                else if (text.includes('(gui√±o)')) head.speakEmoji('üòâ');

                // PASO 6: Pasar el objeto correcto a speakAudio()
                log(`Iniciando lipsync + audio...`);
                await head.speakAudio({
                    audio: audioBuffer,
                    words: words,
                    wtimes: wtimes,
                    wdurations: wdurations
                });

                log(`Avatar reproduciendo audio.`);

            } catch (e) { log(`Error en Habla: ${e.message}`, 'error'); console.error(e); }
            finally {
                speakBtn.disabled = false;
                speakBtn.style.filter = "none";
            }
        }

        // --- GESTOS Y CAMARA ---
        window.playGesture = function (name) {
            log(`Ejecutando gesto: ${name}`);
            const gestures = { 'wave': 'waving', 'shrug': 'shrugging', 'think': 'thoughtful', 'agree': 'nodding' };
            try { head.playAnimation(gestures[name] || name); } catch (e) { }
        }

        window.addExpression = function (tag) {
            textInput.value += " " + tag;
            textInput.focus();
        }

        // Aplica un preset de c√°mara actualizando sliders y la vista en un solo clic
        // Autor: Ing. Walter Rodr√≠guez - 2026-02-20
        // h=altura, z=zoom, ry=giro eje Y (izq/der), rx=giro eje X (arriba/abajo)
        function applyPreset(h, z, ry, rx = 1.4) {
            document.getElementById('cam-height').value = h;
            document.getElementById('cam-zoom').value = z;
            document.getElementById('cam-rotate-y').value = ry;
            document.getElementById('cam-rotate-x').value = rx;
            updateCamera();
            log(`Preset: h=${h}, zoom=${z}, giroY=${ry}, giroX=${rx}`);
        }

        // Actualiza c√°mara y giro a partir de los sliders
        // Usa head.controls (OrbitControls de Three.js) ‚Äî mismo mecanismo que el mouse
        // ALTURA ‚Üí controls.target.y (mueve el punto focal, no la c√°mara directamente)
        // ZOOM   ‚Üí camera.zoom (tama√±o del frustum en c√°mara ortogr√°fica)
        // GIRO Y ‚Üí azimuthAngle (izq/der, igual a drag horizontal del mouse)
        // GIRO X ‚Üí polarAngle  (arriba/abajo, igual a drag vertical del mouse)
        // Autor: Ing. Walter Rodr√≠guez - 2026-02-20
        function updateCamera() {
            const h = parseFloat(document.getElementById('cam-height').value);
            const z = parseFloat(document.getElementById('cam-zoom').value);
            const ry = parseFloat(document.getElementById('cam-rotate-y').value);
            const rx = parseFloat(document.getElementById('cam-rotate-x').value);

            document.getElementById('h-val').innerText = h.toFixed(2);
            document.getElementById('z-val').innerText = z.toFixed(2);
            document.getElementById('ry-val').innerText = ry.toFixed(2);
            document.getElementById('rx-val').innerText = rx.toFixed(2);

            if (!head) return;
            try {
                // ZOOM: camera.zoom es seguro porque no lo sobreescribe OrbitControls
                if (head.camera) {
                    head.camera.zoom = Math.max(0.1, z);
                    head.camera.updateProjectionMatrix();
                }

                if (head.controls) {
                    // ALTURA: mover el punto focal (target.y) en lugar de camera.position.y
                    // OrbitControls sobreescribe camera.position en cada update(), pero
                    // target.y persiste porque es el ancla de la √≥rbita
                    head.controls.target.y = h;

                    // GIRO: forzar √°ngulos bloqueando min=max, luego liberamos para el mouse
                    head.controls.minAzimuthAngle = ry;
                    head.controls.maxAzimuthAngle = ry;
                    head.controls.minPolarAngle = rx;
                    head.controls.maxPolarAngle = rx;
                    head.controls.update();

                    // Liberar l√≠mites para seguir usando el mouse libremente
                    setTimeout(() => {
                        if (head && head.controls) {
                            head.controls.minAzimuthAngle = -Infinity;
                            head.controls.maxAzimuthAngle = Infinity;
                            head.controls.minPolarAngle = 0;
                            head.controls.maxPolarAngle = Math.PI;
                        }
                    }, 80);
                } else {
                    // Fallback sin OrbitControls: mover c√°mara directamente
                    if (head.camera) {
                        head.camera.position.y = h;
                        head.camera.updateProjectionMatrix();
                    }
                    if (head.scene) {
                        let avatarRoot = null;
                        head.scene.traverse((obj) => {
                            if (!avatarRoot && obj.isGroup && obj.parent === head.scene) {
                                avatarRoot = obj;
                            }
                        });
                        const t = head.avatar || avatarRoot;
                        if (t) {
                            t.rotation.y = ry;
                            t.rotation.x = (rx - 1.4) * 0.3;
                        }
                    }
                }
            } catch (e) { log('Cam error: ' + e.message, 'warn'); }
        }


        function syncSliders() {
            if (head && head.camera) {
                updateCamera();
            }
        }

        // ======== L√≥gica de Inventario Live - Autor: Ing. Walter Rodr√≠guez - 2026-02-20 ========
        let inventoryItems = [];
        let currentItemIdx = -1;
        let mediaCarouselInterval = null;
        let currentMediaFiles = [];
        let currentMediaIdx = 0;

        async function initInventory() {
            try {
                const resp = await fetch('/inventario/data');
                const data = await resp.json();
                if (data.status === 'ok' && data.items && data.items.length > 0) {
                    inventoryItems = data.items;
                    document.getElementById('inventory-counter').innerText = `0/${inventoryItems.length}`;
                    document.getElementById('next-item-btn').disabled = false;
                    log(`Inventario cargado: ${inventoryItems.length} art√≠culos.`);
                } else {
                    log(`Inventario vac√≠o o error: ${data.message || 'Sin items'}`, 'warn');
                    console.log('Datos recibidos inventario:', data);
                }
            } catch (e) {
                log('Error cargando inventario: ' + e.message, 'warn');
            }
        }

        async function nextInventoryItem() {
            if (currentItemIdx >= inventoryItems.length - 1) return;

            currentItemIdx++;
            const item = inventoryItems[currentItemIdx];
            const btn = document.getElementById('next-item-btn');
            const counter = document.getElementById('inventory-counter');
            const overlay = document.getElementById('inventory-overlay');

            // Actualizar UI
            counter.innerText = `${currentItemIdx + 1}/${inventoryItems.length}`;
            overlay.style.display = 'flex';
            document.getElementById('display-name').innerText = item.Nombre || 'Sin nombre';
            document.getElementById('display-desc').innerText = item.Descripci√≥n || '';

            if (currentItemIdx === inventoryItems.length - 1) {
                btn.disabled = true;
                btn.innerText = '‚úÖ FIN DE INVENTARIO';
            }

            // 1. Que el avatar lo diga
            // Autor: Ing. Walter Rodr√≠guez - 2026-02-20
            const q = item.Cantidad || 0;
            const script = `${item.Nombre}. Vamos a vender ${q} unidades. ${item.Descripci√≥n}`;
            document.getElementById('text-input').value = script;
            hablarTexto();

            // 2. Cargar y mostrar multimedia
            try {
                const fResp = await fetch(`/inventario/files/${item.ID}`);
                const fData = await fResp.json();
                if (fData.status === 'ok' && fData.files.length > 0) {
                    currentMediaFiles = fData.files;
                    currentMediaIdx = 0;
                    showMedia(currentMediaFiles[0]);
                } else {
                    document.getElementById('media-view').innerHTML = '<div style="color:#475569; font-size:10px;">Sin multimedia</div>';
                }
            } catch (e) {
                log('Error cargando media: ' + e.message, 'warn');
            }
        }

        function showMedia(file) {
            const container = document.getElementById('media-view');
            container.innerHTML = '';
            clearTimeout(mediaCarouselInterval);

            if (file.type === 'image') {
                const img = document.createElement('img');
                img.src = file.url;
                img.style.animation = 'fadeIn 0.5s ease';
                container.appendChild(img);
                mediaCarouselInterval = setTimeout(nextMedia, 4000);
            } else if (file.type === 'video') {
                const vid = document.createElement('video');
                vid.src = file.url;
                vid.autoplay = true;
                vid.muted = false;
                vid.style.width = '100%';
                vid.style.height = '100%';
                container.appendChild(vid);
                vid.onended = nextMedia;
                vid.onerror = nextMedia;
            }
        }

        function nextMedia() {
            if (currentMediaFiles.length <= 1) return;
            currentMediaIdx = (currentMediaIdx + 1) % currentMediaFiles.length;
            showMedia(currentMediaFiles[currentMediaIdx]);
        }

        document.getElementById('next-item-btn').onclick = nextInventoryItem;
        initInventory();

        // --- EVENTOS de c√°mara ---
        // Escuchar cambios en todos los sliders - Autor: Ing. Walter Rodr√≠guez - 2026-02-20
        ['cam-height', 'cam-zoom', 'cam-rotate-y', 'cam-rotate-x'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', updateCamera);
        });

        document.getElementById('reset-cam-btn').onclick = () => {
            document.getElementById('cam-height').value = 0.90;
            document.getElementById('cam-zoom').value = 0.36;
            document.getElementById('cam-rotate-y').value = 0;
            document.getElementById('cam-rotate-x').value = 1.4;
            updateCamera();
        };

        document.getElementById('download-btn').onclick = () => downloadAvatar();

        // Bot√≥n ADAPTAR - Autor: Ing. Walter Rodr√≠guez - 2026-02-20
        document.getElementById('adaptar-btn').onclick = () => adaptarTexto();

        async function adaptarTexto() {
            const texto = textInput.value.trim();
            if (!texto) {
                alert('Escribe un texto primero en el campo de Comunicaci√≥n Humana');
                return;
            }
            const btn = document.getElementById('adaptar-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Analizando...';
            log('Enviando texto a Gemini para adaptar expresiones...');

            try {
                const resp = await fetch('/adaptar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ texto: texto })
                });
                const data = await resp.json();
                if (data.status === 'ok') {
                    textInput.value = data.texto_adaptado;
                    log(`Texto adaptado con √©xito (${data.texto_adaptado.length} chars)`);
                    textInput.style.borderColor = '#c084fc';
                    textInput.style.boxShadow = '0 0 10px rgba(192,132,252,0.4)';
                    setTimeout(() => {
                        textInput.style.borderColor = '';
                        textInput.style.boxShadow = '';
                    }, 2000);
                } else {
                    log('Error Gemini: ' + data.message, 'error');
                    showApiError(data.message);
                }
            } catch (e) {
                log('Error red: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ú® ADAPTAR';
            }
        }

        // ‚îÄ‚îÄ TEST API: verifica si la Google-API-KEY funciona ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Autor: Ing. Walter Rodr√≠guez - 2026-02-20
        document.getElementById('test-api-btn').onclick = () => testApiGemini();

        async function testApiGemini() {
            const btn = document.getElementById('test-api-btn');
            btn.textContent = '‚è≥ Verificando...';
            btn.disabled = true;
            log('Verificando Google-API-KEY con Gemini...');

            try {
                const resp = await fetch('/test-api');
                const data = await resp.json();

                if (data.status === 'ok') {
                    // Mostrar modal verde con modelos disponibles
                    showApiInfo(
                        '‚úÖ API KEY V√ÅLIDA',
                        `Key detectada: ${data.key_preview}\n\nModelos disponibles para tu key (${data.total}):\n\n` +
                        data.modelos_disponibles.map(m => `  ‚Ä¢ ${m}`).join('\n')
                    );
                    log(`API OK. ${data.total} modelos disponibles.`);
                } else {
                    showApiError('‚ùå API KEY CON PROBLEMAS\n\n' + data.message);
                    log('Test API fall√≥: ' + data.message, 'error');
                }
            } catch (e) {
                showApiError('‚ùå Error de red al verificar la API:\n\n' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç TEST API GEMINI';
            }
        }

        function showApiInfo(titulo, msg) {
            let modal = document.getElementById('api-info-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'api-info-modal';
                modal.style.cssText = `
                    position:fixed; inset:0; z-index:9999;
                    background:rgba(0,0,0,0.75); backdrop-filter:blur(4px);
                    display:flex; align-items:center; justify-content:center;
                    padding:20px; box-sizing:border-box;
                `;
                modal.innerHTML = `
                    <div style="
                        background:#0f172a; border:1px solid rgba(16,185,129,0.4);
                        border-radius:12px; padding:28px; max-width:480px; width:100%;
                        box-shadow:0 0 40px rgba(16,185,129,0.15);
                    ">
                        <div id="api-info-title" style="color:#6ee7b7; font-size:13px; font-weight:600; letter-spacing:1px; margin-bottom:12px;"></div>
                        <div id="api-info-text" style="color:#e2e8f0; font-size:12px; line-height:1.8; white-space:pre-wrap; word-break:break-word; max-height:300px; overflow-y:auto;"></div>
                        <button onclick="document.getElementById('api-info-modal').style.display='none'" style="
                            margin-top:20px; width:100%; padding:10px;
                            background:rgba(16,185,129,0.15); border:1px solid rgba(16,185,129,0.4);
                            border-radius:8px; color:#6ee7b7; cursor:pointer;
                            font-family:inherit; font-size:12px; letter-spacing:1px;
                        ">CERRAR</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            document.getElementById('api-info-title').textContent = titulo;
            document.getElementById('api-info-text').textContent = msg;
            modal.style.display = 'flex';
        }

        // Mostrar modal de error descriptivo para fallos de API
        // Reemplaza el alert() gen√©rico con un mensaje formateado y estilizado
        // Autor: Ing. Walter Rodr√≠guez - 2026-02-20
        function showApiError(msg) {
            // Crear modal din√°mico si no existe
            let modal = document.getElementById('api-error-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'api-error-modal';
                modal.style.cssText = `
                    position:fixed; inset:0; z-index:9999;
                    background:rgba(0,0,0,0.75); backdrop-filter:blur(4px);
                    display:flex; align-items:center; justify-content:center;
                    padding:20px; box-sizing:border-box;
                `;
                modal.innerHTML = `
                    <div style="
                        background:#0f172a; border:1px solid rgba(239,68,68,0.4);
                        border-radius:12px; padding:28px; max-width:480px; width:100%;
                        box-shadow:0 0 40px rgba(239,68,68,0.15);
                    ">
                        <div style="color:#ef4444; font-size:13px; font-weight:600; letter-spacing:1px; margin-bottom:12px;">ERROR DE API</div>
                        <div id="api-error-text" style="color:#e2e8f0; font-size:13px; line-height:1.7; white-space:pre-wrap; word-break:break-word;"></div>
                        <button onclick="document.getElementById('api-error-modal').style.display='none'" style="
                            margin-top:20px; width:100%; padding:10px;
                            background:rgba(239,68,68,0.15); border:1px solid rgba(239,68,68,0.4);
                            border-radius:8px; color:#ef4444; cursor:pointer;
                            font-family:inherit; font-size:12px; letter-spacing:1px;
                        ">CERRAR</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            // Rellenar con el mensaje del backend y mostrar
            document.getElementById('api-error-text').textContent = msg;
            modal.style.display = 'flex';
        }

        if (obsToggle) {
            obsToggle.onclick = () => mainPanel.classList.toggle('hidden');
        }

        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'h' && document.activeElement.tagName !== 'TEXTAREA') {
                mainPanel.classList.toggle('hidden');
            }
        });

        const rateRange = document.getElementById('rate-range');
        if (rateRange) {
            rateRange.oninput = (e) => {
                document.getElementById('rate-value').innerText = (e.target.value >= 0 ? '+' : '') + e.target.value + '%';
            };
        }

        speakBtn.onclick = handleSpeak;

        // --- EXPONER FUNCIONES AL SCOPE GLOBAL ---
        // IMPORTANTE: En <script type="module">, las funciones NO son globales.
        // Los onclick inline del HTML necesitan acceder a ellas via window.*
        // Autor: Ing. Walter Rodr√≠guez - 2026-02-20
        window.applyPreset = applyPreset;
        window.addExpression = addExpression;

        // --- INICIO ---
        init();

    </script>
</body>

</html>